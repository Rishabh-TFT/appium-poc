default:
    image: python:3.10.2

stages:
    - dependency
    - test01
    - test02
    - test03
    - test04
    - test05
    - poland01
    - production
    - other

dependency:
  stage: dependency
  variables:
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  cache:
    paths:
      - .cache/pip
      - venv/
  artifacts:
    paths:
      - .cache/pip
      - venv/
    expire_in: 1 days
  script:
    - python -V               # Print out python version for debugging
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - apt-get update
    - apt-get install -y python3-pip
    - pip install -r requirements.txt
  when: always

.base_triggerable_old:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "pipeline" && $TRIGGERED_JOB == $CI_JOB_NAME'
      when: always
      allow_failure: true
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $TRIGGERED_JOB == $CI_JOB_NAME'
      when: always
      allow_failure: true
    - if: '$CI_PIPELINE_SOURCE != "pipeline"'
      when: manual
      allow_failure: true

.base_triggerable:
  before_script:
    - USER_NAME=${GITLAB_USER_LOGIN//.}
    - BS_KEY=K8S_SECRET_${USER_NAME}
    - BS_ACCESS_KEY=BS_KEY_${USER_NAME}
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "pipeline" && $TRIGGERED_JOB == $CI_JOB_NAME'
      when: always
      allow_failure: true
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $TRIGGERED_JOB == $CI_JOB_NAME'
      when: always
      allow_failure: true
    - if: '$CI_PIPELINE_SOURCE != "pipeline"'
      when: manual
      allow_failure: true
  variables:
    PYTEST_CACHE_DIR: "$CI_PROJECT_DIR/.pytest_cache/v/cache"
  cache:
    key: $CI_JOB_NAME-$CI_PIPELINE_ID
    paths:
      - .pytest_cache/v/cache
    when: always
  retry:
    max: 2
  timeout: 4h

.base_triggerable_headless:
  before_script:
    - apt-get update
    - apt-get install -y bind9 dnsutils
    - CHROME_DRIVER_VERSION=`curl -sS https://chromedriver.storage.googleapis.com/LATEST_RELEASE`

    # Install Chrome.
    - curl -sS -o - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add
    - echo "deb https://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list
    - apt-get -y update
    - apt-get -y install google-chrome-stable

    # Install ChromeDriver.
    - wget -N https://chromedriver.storage.googleapis.com/$CHROME_DRIVER_VERSION/chromedriver_linux64.zip -P ~/
    - unzip ~/chromedriver_linux64.zip -d ~/
    - rm ~/chromedriver_linux64.zip
    - mv -f ~/chromedriver /usr/local/bin/chromedriver
    - chown root:root /usr/local/bin/chromedriver
    - chmod 0755 /usr/local/bin/chromedriver
    - USER_NAME=${GITLAB_USER_LOGIN//.}
    - BS_KEY=K8S_SECRET_${USER_NAME}
    - BS_ACCESS_KEY=BS_KEY_${USER_NAME}
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "pipeline" && $TRIGGERED_JOB == $CI_JOB_NAME'
      when: always
      allow_failure: true
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $TRIGGERED_JOB == $CI_JOB_NAME'
      when: always
      allow_failure: true
    - if: '$CI_PIPELINE_SOURCE != "pipeline"'
      when: manual
      allow_failure: true
  variables:
    PYTEST_CACHE_DIR: "$CI_PROJECT_DIR/.pytest_cache/v/cache"
  cache:
    key: $CI_JOB_NAME-$CI_PIPELINE_ID
    paths:
      - .pytest_cache/v/cache
    when: always
  retry:
    max: 2
  timeout: 4h

# stage test01

auth_suite_test01:
  extends: .base_triggerable
  stage: test01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_auth_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

sanity_suite_test01:
  extends: .base_triggerable
  stage: test01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k=$SCENARIO -n 4 --max-worker-restart 5
  after_script:
    - sleep 12

cancellation_flow_test01:
  extends: .base_triggerable
  stage: test01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} CURRENCY_IP=$GEO_IP BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_cancellation_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

image_resizer_test01:
  extends: .base_triggerable
  stage: test01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_image_resizer_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

smoke_suite_headless_test01:
  extends: .base_triggerable_headless
  stage: test01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=headless_chrome url=https://test01.promo.com pytest test_smoke_headless_run.py -n 2 --last-failed -v -k=$SCENARIO --max-worker-restart 5

templates_suite_test01:
  extends: .base_triggerable
  stage: test01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_templates_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

onboarding_suite_test01:
  extends: .base_triggerable
  stage: test01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_onboarding_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5

publisher_scheduler_suite_test01:
  extends: .base_triggerable
  stage: test01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test01.promo.com BS_BUILD_NAME=$CI_JOB_NAME TID=?tid=60620221 pytest test_scheduler_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

links_suite_test01:
  extends: .base_triggerable
  stage: test01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_links_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

editorial_suite_test01:
  extends: .base_triggerable
  stage: test01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_editorial_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

publish_pricing_test01:
  extends: .base_triggerable
  stage: test01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k="test_signup_verify_premium_tags_and_see_pricing or test_signup_verify_editorial_tags_and_see_pricing or test_new_user_purchases_a_plan" -n 3 --max-worker-restart 5
  after_script:
    - sleep 12

# stage test02

sanity_suite_test02:
  extends: .base_triggerable
  stage: test02
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test02.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k=$SCENARIO -n 4 --max-worker-restart 5
  after_script:
    - sleep 12

auth_suite_test02:
  extends: .base_triggerable
  stage: test02
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test02.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_auth_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

cancellation_flow_test02:
  extends: .base_triggerable
  stage: test02
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} CURRENCY_IP=$GEO_IP BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test02.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_cancellation_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

image_resizer_test02:
  extends: .base_triggerable
  stage: test02
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test02.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_image_resizer_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

links_suite_test02:
  extends: .base_triggerable
  stage: test02
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test02.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_links_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

smoke_suite_headless_test02:
  extends: .base_triggerable_headless
  stage: test02
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=headless_chrome url=https://test02.promo.com pytest test_smoke_headless_run.py -n 2 --last-failed -v -k=$SCENARIO --max-worker-restart 5

templates_suite_test02:
  extends: .base_triggerable
  stage: test02
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test02.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_templates_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

onboarding_suite_test02:
    extends: .base_triggerable
    stage: test02
    dependencies:
      - dependency
    script:
      - echo ${!BS_KEY}
      - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test02.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_onboarding_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5

publisher_scheduler_suite_test02:
  extends: .base_triggerable
  stage: test02
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test02.promo.com BS_BUILD_NAME=$CI_JOB_NAME TID=?tid=60620221 pytest test_scheduler_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

editorial_suite_test02:
  extends: .base_triggerable
  stage: test02
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test02.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_editorial_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

publish_pricing_test02:
  extends: .base_triggerable
  stage: test02
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test02.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k="test_signup_verify_premium_tags_and_see_pricing or test_signup_verify_editorial_tags_and_see_pricing or test_new_user_purchases_a_plan" -n 3 --max-worker-restart 5
  after_script:
    - sleep 12

# stage test03

sanity_suite_test03:
  extends: .base_triggerable
  stage: test03
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test03.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k=$SCENARIO -n 4 --max-worker-restart 5
  after_script:
    - sleep 12

links_suite_test03:
  extends: .base_triggerable
  stage: test03
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test03.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_links_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

auth_suite_test03:
  extends: .base_triggerable
  stage: test03
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test03.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_auth_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

cancellation_flow_test03:
  extends: .base_triggerable
  stage: test03
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} CURRENCY_IP=$GEO_IP BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test03.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_cancellation_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

image_resizer_test03:
  extends: .base_triggerable
  stage: test03
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test03.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_image_resizer_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

smoke_suite_headless_test03:
  extends: .base_triggerable_headless
  stage: test03
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=headless_chrome url=https://test03.promo.com pytest test_smoke_headless_run.py -n 2 --last-failed -v -k=$SCENARIO --max-worker-restart 5

templates_suite_test03:
  extends: .base_triggerable
  stage: test03
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta  url=https://test03.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_templates_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

onboarding_suite_test03:
  extends: .base_triggerable
  stage: test03
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test03.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_onboarding_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5

publisher_scheduler_suite_test03:
  extends: .base_triggerable
  stage: test03
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test03.promo.com BS_BUILD_NAME=$CI_JOB_NAME TID=?tid=60620221 pytest test_scheduler_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

editorial_suite_test03:
  extends: .base_triggerable
  stage: test03
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test03.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_editorial_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

publish_pricing_test03:
  extends: .base_triggerable
  stage: test03
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test03.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k="test_signup_verify_premium_tags_and_see_pricing or test_signup_verify_editorial_tags_and_see_pricing or test_new_user_purchases_a_plan" -n 3 --max-worker-restart 5
  after_script:
    - sleep 12

# stage test04

sanity_suite_test04:
  extends: .base_triggerable
  stage: test04
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test04.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k=$SCENARIO -n 4 --max-worker-restart 5
  after_script:
    - sleep 12

links_suite_test04:
  extends: .base_triggerable
  stage: test04
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test04.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_links_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

auth_suite_test04:
  extends: .base_triggerable
  stage: test04
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test04.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_auth_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

image_resizer_test04:
  extends: .base_triggerable
  stage: test04
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test04.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_image_resizer_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

smoke_suite_headless_test04:
  extends: .base_triggerable_headless
  stage: test04
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=headless_chrome url=https://test04.promo.com pytest test_smoke_headless_run.py -n 2 --last-failed -v -k=$SCENARIO --max-worker-restart 5

templates_suite_test04:
  extends: .base_triggerable
  stage: test04
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta  url=https://test04.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_templates_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

publisher_scheduler_suite_test04:
  extends: .base_triggerable
  stage: test04
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test04.promo.com BS_BUILD_NAME=$CI_JOB_NAME TID=?tid=60620221 pytest test_scheduler_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

editorial_suite_test04:
  extends: .base_triggerable
  stage: test04
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test04.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_editorial_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

onboarding_suite_test04:
  extends: .base_triggerable
  stage: test04
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test04.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_onboarding_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5

publish_pricing_test04:
  extends: .base_triggerable
  stage: test04
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test04.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k="test_signup_verify_premium_tags_and_see_pricing or test_signup_verify_editorial_tags_and_see_pricing or test_new_user_purchases_a_plan" -n 3 --max-worker-restart 5
  after_script:
    - sleep 12

cancellation_flow_test04:
  extends: .base_triggerable
  stage: test04
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} CURRENCY_IP=$GEO_IP BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test04.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_cancellation_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

# stage test05

sanity_suite_test05:
  extends: .base_triggerable
  stage: test05
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test05.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k=$SCENARIO -n 4 --max-worker-restart 5
  after_script:
    - sleep 12

links_suite_test05:
  extends: .base_triggerable
  stage: test05
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test05.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_links_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

auth_suite_test05:
  extends: .base_triggerable
  stage: test05
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test05.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_auth_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

image_resizer_test05:
  extends: .base_triggerable
  stage: test05
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test05.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_image_resizer_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

smoke_suite_headless_test05:
  extends: .base_triggerable_headless
  stage: test05
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=headless_chrome url=https://test05.promo.com pytest test_smoke_headless_run.py -n 2 --last-failed -v -k=$SCENARIO --max-worker-restart 5

templates_suite_test05:
  extends: .base_triggerable
  stage: test05
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test05.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_templates_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

onboarding_suite_test05:
  extends: .base_triggerable
  stage: test05
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test05.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_onboarding_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5

publisher_scheduler_suite_test05:
  extends: .base_triggerable
  stage: test05
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test05.promo.com BS_BUILD_NAME=$CI_JOB_NAME TID=?tid=60620221 pytest test_scheduler_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

editorial_suite_test05:
  extends: .base_triggerable
  stage: test05
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test05.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_editorial_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

publish_pricing_test05:
  extends: .base_triggerable
  stage: test05
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test05.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k="test_signup_verify_premium_tags_and_see_pricing or test_signup_verify_editorial_tags_and_see_pricing or test_new_user_purchases_a_plan" -n 3 --max-worker-restart 5
  after_script:
    - sleep 12

cancellation_flow_test05:
  extends: .base_triggerable
  stage: test05
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} CURRENCY_IP=$GEO_IP BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test05.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_cancellation_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

# stage poland01

auth_suite_poland01:
  extends: .base_triggerable
  stage: poland01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://poland01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_auth_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

sanity_suite_poland01:
  extends: .base_triggerable
  stage: poland01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://poland01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k=$SCENARIO -n 4 --max-worker-restart 5
  after_script:
    - sleep 12

links_suite_poland01:
  extends: .base_triggerable
  stage: poland01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://poland01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_links_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

image_resizer_poland01:
  extends: .base_triggerable
  stage: poland01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://poland01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_image_resizer_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

templates_suite_poland01:
  extends: .base_triggerable
  stage: poland01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://poland01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_templates_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

publisher_scheduler_suite_poland01:
  extends: .base_triggerable
  stage: poland01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://poland01.promo.com BS_BUILD_NAME=$CI_JOB_NAME TID=?tid=60620221 pytest test_scheduler_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

editorial_suite_poland01:
  extends: .base_triggerable
  stage: poland01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://poland01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_editorial_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

onboarding_suite_poland01:
  extends: .base_triggerable
  stage: poland01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://poland01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_onboarding_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5

publish_pricing_poland01:
  extends: .base_triggerable
  stage: poland01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://poland01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k="test_signup_verify_premium_tags_and_see_pricing or test_signup_verify_editorial_tags_and_see_pricing or test_new_user_purchases_a_plan" -n 3 --max-worker-restart 5
  after_script:
    - sleep 12

cancellation_flow_poland01:
  extends: .base_triggerable
  stage: poland01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} CURRENCY_IP=$GEO_IP BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://poland01.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_cancellation_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

smoke_suite_headless_poland01:
  extends: .base_triggerable_headless
  stage: poland01
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=headless_chrome url=https://poland01.promo.com pytest test_smoke_headless_run.py -n 2 --last-failed -v -k=$SCENARIO --max-worker-restart 5

# stage production

publish_pricing_prod:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k="test_signup_verify_premium_tags_and_see_pricing or test_signup_verify_editorial_tags_and_see_pricing or test_create_video_from_uploaded_and_publish_it" -n 3 --max-worker-restart 5
  after_script:
    - sleep 12

sanity_suite_prod:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://promo.com BS_BUILD_NAME=$CI_JOB_NAME-Sanity pytest test_run.py --last-failed -v -k=$SCENARIO -n 3 --max-worker-restart 5
  after_script:
    - sleep 12

auth_sanity_suite_prod:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://promo.com BS_BUILD_NAME=$CI_JOB_NAME-AUTH pytest test_auth_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

links_suite_prod:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_links_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

smoke_suite_headless_prod:
  extends: .base_triggerable_headless
  stage: production
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=headless_chrome url=https://promo.com pytest test_smoke_headless_run.py -n 2 --last-failed -v -k=$SCENARIO --max-worker-restart 5

onboarding_suite_prod:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_onboarding_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5

scheduler_suite_prod:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://promo.com BS_BUILD_NAME=$CI_JOB_NAME TID=?tid=60620221 pytest test_scheduler_run.py --last-failed -v -k=$SCENARIO --max-worker-restart 5
  after_script:
    - sleep 12

editorial_suite_prod:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta  url=https://promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_editorial_run.py --last-failed -v -k=$SCENARIO -k test_signup_verify_editorial_tags_and_see_pricing

image_resizer_prod:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_image_resizer_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

templates_suite_prod:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_templates_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5

video_generation_test_prod:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=Promo_All_ENVs BS_BUILD_NAME=$CI_JOB_NAME pytest test_rendering_run.py -k test_generate_video_and_publish[prod]

SEO_Pages_performance_test:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  script:
    - pytest test_performance_run.py --slack_hook=$SLACK_WEBHOOK --slack_username="$CI_JOB_NAME results" --slack_report_link=https://docs.google.com/spreadsheets/d/1pQZXgeOtH50HbvX5adJRlnBPSJuk9npklGl9FucE_mM/edit#gid=0

SEO_Pages_Performance_report:
  extends: .base_triggerable
  stage: production
  dependencies:
    - dependency
  before_script:
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
  script:
    - pytest test_performance_run.py -k test_Check_SEO_Pages_Performance_and_send_on_slack
  allow_failure: true

Shopify_Sanity_Prod:
  extends: .base_triggerable_old
  stage: production
  script:
    - |
       curl -X POST "https://api.testproject.io/v2/projects/${TESTPROJECT_PROJECT_SHOPIFY}/jobs/${TESTPROJECT_JOB_SHOPIY}/run" \
        -H "Accept: application/json" -H "Authorization: ${TESTPROJECT_API_KEY}" \
        -H "Content-Type: application/json"  \
        --data-raw "{\"queue\": true, \"agentId\": \"${TESTPROJECT_AGENT_ID}\"}"

PTV_Sanity_Prod:
  extends: .base_triggerable_old
  stage: production
  script:
    - |
       curl -X POST "https://api.testproject.io/v2/projects/${TESTPROJECT_PROJECT_ID}/jobs/${TESTPROJECT_JOB_ID}/run" \
        -H "Accept: application/json" -H "Authorization: ${TESTPROJECT_API_KEY}" \
        -H "Content-Type: application/json"  \
        --data-raw "{\"queue\": true, \"agentId\": \"${TESTPROJECT_AGENT_ID}\"}"

# stage other

auth_suite_yellow:
  extends: .base_triggerable
  stage: other
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://yellow-php7.slide.ly/ BS_BUILD_NAME=$CI_JOB_NAME aws_access_key=$AWS_ACCESS_KEY_ID aws_secret_access=$AWS_SECRET_ACCESS_KEY bucket_folder=Promo/yellow/auth_test pytest test_env_auth_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

sanity_suite_yellow:
  extends: .base_triggerable
  stage: other
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://yellow-php7.slide.ly BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k=$SCENARIO -n 4 --max-worker-restart 5
  after_script:
    - sleep 12

auth_suite_test06:
  extends: .base_triggerable
  stage: other
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test06.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_auth_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

sanity_suite_test06:
  extends: .base_triggerable
  stage: other
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test06.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k=$SCENARIO -n 4 --max-worker-restart 5
  after_script:
    - sleep 12

smoke_suite_headless_test06:
  extends: .base_triggerable_headless
  stage: other
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=headless_chrome url=https://test06.promo.com pytest test_smoke_headless_run.py -n 2 --last-failed -v -k=$SCENARIO --max-worker-restart

sanity_suite_staging:
  extends: .base_triggerable
  stage: other
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://staging-php7.slide.ly BS_BUILD_NAME=$CI_JOB_NAME pytest test_env_run.py --last-failed -v -k=$SCENARIO -n 4 --max-worker-restart 5
  after_script:
    - sleep 12

cancellation_flow_test06:
  extends: .base_triggerable
  stage: other
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} CURRENCY_IP=$GEO_IP BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=https://test06.promo.com BS_BUILD_NAME=$CI_JOB_NAME pytest test_cancellation_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

trigger_all_envs_renderer:
  extends: .base_triggerable
  stage: other
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=Promo_All_ENVs BS_BUILD_NAME=$CI_JOB_NAME pytest test_rendering_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12

promo_animations_test:
  extends: .base_triggerable
  stage: other
  dependencies:
    - dependency
  script:
    - echo ${!BS_KEY}
    - browser=browserstack BROWSERSTACK=${!BS_KEY} BROWSERSTACK_ACCESS_KEY=${!BS_ACCESS_KEY} BROWSERSTACK_DEF=$K8S_SECRET_rishabhgupta url=Promo_Animations BS_BUILD_NAME=$CI_JOB_NAME pytest test_animation_run.py --last-failed -v -k=$SCENARIO -n 2 --max-worker-restart 5
  after_script:
    - sleep 12


get_email:
  extends: .base_triggerable
  stage: other
  dependencies:
    - dependency
  script:
    - python get_emails.py
  after_script:
    - sleep 12